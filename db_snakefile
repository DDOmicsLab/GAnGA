current_directory = os.getcwd()
db_dir = os.path.join(current_directory,"databases")
tools_dir = os.path.join(current_directory,"tools")

rule all:
    input: 
                os.path.join(current_directory, "flags/checkm.done"),
                os.path.join(current_directory, "flags/bakta_db.done"),


rule CheckM_db_setup:
    input:

    output:
        os.path.join(current_directory, "flags/checkm.done")
    params:
        cd=current_directory,
        db_dir=os.path.join(current_directory, "databases"),
        checkm_dir=os.path.join(current_directory, "databases/checkm")
    conda:
        "envs/checkm.yaml"
    shell:
        """
        echo " Downloading CheckM database..."

        mkdir -p {params.db_dir}

        if [ ! -d "{params.checkm_dir}/checkm_data_2015_01_16" ]; then
            mkdir -p {params.checkm_dir}
            cd {params.checkm_dir}
            wget https://data.ace.uq.edu.au/public/CheckM_databases/checkm_data_2015_01_16.tar.gz
            tar -xvzf checkm_data_2015_01_16.tar.gz
            cd {params.cd}
        else
            echo "âœ… CheckM database already exists."
        fi

        echo -n > {output}
        """


rule Bakta_db_setup:
    input:

    output:
        os.path.join(current_directory, "flags/bakta_db.done")
    params:
        db_dir=os.path.join(current_directory, "databases"),
        cd=current_directory,
        db_path=os.path.join(current_directory, "databases/bakta_db/")
    conda:
        "envs/bakta.yaml"
    shell:
        """
        echo "Downloading Bakta database..."

        bakta_db_dir="{params.db_path}"

        required_files=(
            "$bakta_db_dir/db/bakta.db"
            "$bakta_db_dir/db/antifam.h3f"
            "$bakta_db_dir/db/pfam.h3i"
            "$bakta_db_dir/db/version.json"
        )

        all_files_exist=true
        for file in "${{required_files[@]}}"; do
            if [ ! -f "$file" ]; then
                all_files_exist=false
                break
            fi
        done

        if [ "$all_files_exist" = false ]; then
            echo "Bakta DB not found or incomplete. Proceeding with download..."
            rm -rf "$bakta_db_dir"
            mkdir -p {params.db_dir}
            bakta_db download --output "$bakta_db_dir" --type full
        else
            echo "âœ… Bakta DB already exists and is complete."
        fi

        echo -n > {output}
        true
        """